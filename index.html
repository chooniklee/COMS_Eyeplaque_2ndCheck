<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMS Eye Plaque Calculator</title>
    <!-- Use Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .canvas-container { display: flex; justify-content: center; align-items: center; background-color: white; border-radius: 0.25rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; padding: 0.5rem; }
        
        /* Custom tab button styles */
        .tab-btn { transition: all 0.2s; border-bottom-width: 2px; }
        
        /* Remove arrows/spinners from number inputs to keep text simple */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg space-y-4 p-6">
        
        <!-- Main Header -->
        <div class="text-center border-b pb-4">
            <h2 class="text-xl font-bold text-gray-800">COMS Eye Plaque Physics 2nd Check Calculator</h2>
            <p class="text-sm text-gray-500">TG-43 2nd Check (IsoAid IAI-125A) | Units: Gray (Gy)</p>
        </div>

        <!-- Main Content Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-stretch">

            <!-- COLUMN 1: INPUTS (Schedule & Parameters) -->
            <div class="lg:col-span-3 flex flex-col space-y-4">
                <!-- Schedule Container -->
                <div class="bg-blue-50 rounded-lg border border-blue-100 overflow-hidden flex flex-col h-[210px] shadow-sm shrink-0">
                    <div class="flex border-b border-blue-200 bg-blue-100/50 shrink-0">
                        <button id="btn-mode-duration" class="flex-1 py-1.5 text-xs font-bold uppercase text-blue-900 bg-blue-50 border-b-2 border-blue-600 focus:outline-none">Duration</button>
                        <button id="btn-mode-dates" class="flex-1 py-1.5 text-xs font-bold uppercase text-blue-400 hover:text-blue-600 border-b-2 border-transparent focus:outline-none">Dates</button>
                    </div>

                    <div class="p-3 flex flex-col flex-1 justify-between min-h-0">
                        <!-- Input Mode: Duration -->
                        <div id="mode-content-duration" class="block flex flex-col justify-center flex-1 space-y-1">
                            <label class="block text-[10px] font-bold text-blue-800 uppercase text-center">Total Time (Hours)</label>
                            <input type="number" id="manualDuration" step="0.1" value="101.0" class="w-full p-1.5 text-2xl font-mono font-bold text-blue-700 text-center bg-white border border-blue-200 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>

                        <!-- Input Mode: Dates -->
                        <div id="mode-content-dates" class="hidden flex flex-col space-y-2 flex-1 justify-center">
                            <div class="flex justify-between items-center gap-2">
                                <span class="text-[11px] font-bold text-gray-500 uppercase">Implant</span>
                                <input type="datetime-local" id="implantDate" step="1800" class="flex-1 p-1 text-[11px] border rounded bg-white">
                            </div>
                            <div class="flex justify-between items-center gap-2">
                                <span class="text-[11px] font-bold text-gray-500 uppercase">Removal</span>
                                <input type="datetime-local" id="removalDate" step="1800" class="flex-1 p-1 text-[11px] border rounded bg-white">
                            </div>
                            <div class="flex justify-between text-[11px] bg-white/60 p-1 rounded">
                                <span class="font-bold text-gray-500 uppercase">Calculated Duration</span>
                                <span class="font-bold text-blue-700" id="dateModeDurationDisplay">101.0 h</span>
                            </div>
                        </div>

                        <!-- Decay Correction Info -->
                        <div class="border-t border-blue-200 pt-2 shrink-0">
                            <div class="flex justify-between items-center">
                                <span class="text-[11px] font-bold text-blue-900 uppercase leading-none">Decay Corrected:</span>
                                <span class="font-mono font-bold text-base text-blue-800" id="decayFactorDisplay">0.000 h</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parameters Panel -->
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex-1">
                    <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-3">
                        <h3 class="text-xs font-bold text-gray-800 uppercase">Parameters</h3>
                        <!-- Calc Mode Toggle -->
                        <div class="flex bg-gray-100 rounded p-0.5">
                             <button id="mode-calc-fwd" class="px-2 py-0.5 text-[10px] font-bold rounded shadow bg-white text-blue-800 transition-all">Input Activity</button>
                             <button id="mode-calc-bwd" class="px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-gray-600 transition-all">Input Dose</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-x-3 gap-y-3">
                        <!-- Dynamic Activity/Dose Input Section -->
                        <div class="col-span-2">
                            <!-- Forward Mode: Input Activity -->
                            <div id="input-group-activity" class="block">
                                <label class="block text-[12px] font-semibold text-gray-600 mb-1">IAI-125A Activity (U/seed)</label>
                                <input type="number" id="seedActivity" step="0.01" value="0.00" class="w-full px-2 py-1.5 text-sm font-bold text-red-700 border border-red-200 bg-red-50/50 rounded-md focus:ring-2 focus:ring-red-500 outline-none">
                            </div>
                            
                            <!-- Backward Mode: Input Target Dose -->
                            <div id="input-group-dose" class="hidden">
                                 <label class="block text-[12px] font-semibold text-gray-600 mb-1">Target Rx Dose (Gy)</label>
                                 <div class="flex gap-2 items-stretch">
                                     <input type="number" id="targetDoseInput" step="1.0" value="85.0" class="w-1/2 px-2 py-1.5 text-sm font-bold text-green-700 border border-green-200 bg-green-50 rounded-md focus:ring-2 focus:ring-green-500 outline-none">
                                     <div class="w-1/2 bg-gray-50 border border-gray-200 rounded px-2 py-0.5 flex flex-col justify-center items-center">
                                         <span class="text-[9px] text-gray-400 uppercase leading-none mb-0.5">Needs</span>
                                         <span class="text-sm font-bold text-red-600 leading-none truncate w-full text-center" id="calculatedActivityDisplay">-- U</span>
                                     </div>
                                 </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[12px] font-semibold text-gray-600 mb-1">Rx depth (mm)</label>
                            <input type="number" id="tumorHeight" step="0.1" value="5.0" class="w-full px-2 py-1.5 text-sm border rounded-md">
                        </div>
                        <div>
                            <label class="block text-[12px] font-semibold text-gray-600 mb-1">Plaque Size</label>
                            <select id="plaqueSize" class="w-full px-2 py-1.5 text-sm border rounded-md">
                                <option value="10">10 mm</option>
                                <option value="12">12 mm</option>
                                <option value="14">14 mm</option>
                                <option value="16" selected>16 mm</option>
                                <option value="18">18 mm</option>
                                <option value="20">20 mm</option>
                                <option value="22">22 mm</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[12px] font-semibold text-gray-600 mb-1">Shape</label>
                            <div class="flex gap-4 mt-0.5 bg-gray-50 px-3 py-1.5 rounded-md border border-gray-100">
                                <label class="text-[12px] flex items-center gap-1.5 cursor-pointer">
                                    <input type="radio" name="shape" value="round" checked class="text-blue-600"> Round
                                </label>
                                <label id="labelNotched" class="text-[12px] flex items-center gap-1.5 cursor-pointer">
                                    <input type="radio" name="shape" value="notched" class="text-blue-600" id="radioNotched"> Notched
                                </label>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-[12px] font-semibold text-gray-600 mb-1">Model</label>
                            <div class="flex gap-4 mt-0.5 bg-gray-50 px-3 py-1.5 rounded-md border border-gray-100">
                                <label class="text-[12px] flex items-center gap-1.5 cursor-pointer">
                                    <input type="radio" name="calcMode" value="line" checked class="text-blue-600"> Line Source
                                </label>
                                <label class="text-[12px] flex items-center gap-1.5 cursor-pointer">
                                    <input type="radio" name="calcMode" value="point" class="text-blue-600"> Point Source
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMN 2: UNIFIED RESULTS -->
            <div class="lg:col-span-5 flex flex-col">
                <div id="result-container" class="bg-green-50 rounded-lg border border-green-200 shadow-sm flex-col flex h-full overflow-hidden">
                    <div class="bg-green-100/50 border-b border-green-200 py-2 px-4 shrink-0">
                        <h3 class="text-xs font-bold text-green-900 uppercase text-center">Dose Calculation & 2nd Check</h3>
                    </div>

                    <div class="p-4 flex-1 flex flex-col min-h-0">
                        <div id="unified-table-content" class="flex-1 min-h-0 overflow-y-auto">
                            <table class="w-full text-left border-collapse table-fixed">
                                <thead>
                                    <tr class="border-b border-green-300 text-[11px] uppercase text-green-800">
                                        <th class="py-2 px-1 w-[32%]">Point</th>
                                        <th class="py-2 px-1 w-[26%] text-right">Calc</th>
                                        <th class="py-2 px-1 w-[22%] text-center">TPS</th>
                                        <th class="py-2 px-1 w-[20%] text-right">%Error</th>
                                    </tr>
                                </thead>
                                <tbody id="comparison-rows" class="divide-y divide-green-100">
                                    <!-- Rows injected by JS -->
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 pt-4 border-t border-green-300">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-green-800 font-bold uppercase mb-1">Prescription (Rx) Summary</span>
                                <div class="flex justify-between items-baseline bg-white/40 p-2 rounded-lg border border-green-200">
                                    <div class="text-sm text-green-900 font-bold">Rx Depth <span class="text-xs font-normal opacity-70" id="dose-apex-label">(5mm)</span></div>
                                    <div class="text-3xl font-black text-green-950"><span id="dose-apex">0.00</span><span class="text-sm font-normal ml-1">Gy</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-2 text-center shrink-0">
                            <button id="toggleTableBtn" class="text-xs font-bold text-blue-600 hover:underline focus:outline-none">Show Detailed Physics Check</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLUMN 3: VISUALIZATION -->
            <div class="lg:col-span-4 flex flex-col">
                <div class="bg-gray-50 rounded-lg border border-gray-200 h-full flex flex-col overflow-hidden shadow-sm">
                    <!-- Unified Header for Visualization -->
                    <div class="bg-gray-100 border-b border-gray-200 py-2 px-4 shrink-0 flex flex-col items-center">
                        <h3 class="text-xs font-bold text-gray-700 uppercase text-center" id="plaque-desc-label">Plaque Geometry</h3>
     
                    </div>
                    
                    <div class="p-4 flex flex-col flex-1 justify-center items-center">
                        <div class="canvas-container w-full bg-white flex-1 min-h-[300px]">
                            <canvas id="plaqueCanvas" width="450" height="420" class="max-w-full h-auto"></canvas>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-2 text-center leading-tight">
                            Visual representation (TG-129 X-Y plane)
                            <span id="notchLegend" class="hidden font-bold"><br><span class="text-red-500">Red</span>: Removed notched seed position</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Detailed Physics Breakdown Table -->
        <div id="detailedTableContainer" class="hidden mt-6 border rounded-lg overflow-hidden shadow-md">
            <div class="bg-gray-100 px-4 py-3 border-b">
                <h3 class="text-sm font-bold text-gray-700">Detailed Physics Check: Rx Depth (Apex)</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs text-center">
                    <thead class="bg-gray-50 text-gray-600 font-bold">
                        <tr>
                            <th class="py-2 px-3 border-b">Seed #</th>
                            <th class="py-2 px-3 border-b">x (mm)</th>
                            <th class="py-2 px-3 border-b">y (mm)</th>
                            <th class="py-2 px-3 border-b">z (mm)</th>
                            <th class="py-2 px-3 border-b">Dist r (mm)</th>
                            <th class="py-2 px-3 border-b">Theta (deg)</th>
                            <th class="py-2 px-3 border-b text-blue-600" id="header-g">g(r)</th>
                            <th class="py-2 px-3 border-b">G(r,θ)</th>
                            <th class="py-2 px-3 border-b text-blue-600">F(r,θ)</th>
                            <th class="py-2 px-3 border-b">Dose (Gy)</th>
                        </tr>
                    </thead>
                    <tbody id="detailedTableBody" class="divide-y divide-gray-100 bg-white"></tbody>
                    <tfoot class="bg-gray-50 font-bold text-gray-800">
                        <tr>
                            <td colspan="9" class="py-3 px-3 text-right text-sm">Total Dose @ Rx Depth:</td>
                            <td class="py-3 px-3 border-t border-gray-300 text-sm" id="detailedTableTotal">0.0000 Gy</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <div class="text-[11px] text-gray-400 text-center border-t pt-4">
            * <strong>IsoAid IAI-125A</strong>. TG-129 Coords. Homogeneous water approximation.
        </div>

    </div>

    <!-- MAIN APP LOGIC -->
    <script>
        // --- DATA CONSTANTS (TG-129 / Isotope Parameters) ---
        const ISOTOPE_CONSTANTS = { name: "IsoAid IAI-125A", Lambda: 0.981, L: 0.30, HalfLife: 59.43 };
        
        const G_TABLE = {
            r: [0.10, 0.15, 0.25, 0.50, 0.75, 1.00, 1.50, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, 10.00],
            line: [1.040, 1.053, 1.066, 1.080, 1.035, 1.000, 0.902, 0.800, 0.611, 0.468, 0.368, 0.294, 0.227, 0.165, 0.141, 0.090],
            point: [0.686, 0.833, 0.967, 1.056, 1.029, 1.000, 0.906, 0.804, 0.615, 0.471, 0.371, 0.296, 0.229, 0.166, 0.142, 0.091]
        };

        const F_TABLE = {
            r: [0.5, 1.0, 2.0, 3.0, 5.0, 7.0], theta: [0, 5, 10, 20, 30, 40, 50, 60, 70, 80, 90],
            data: [
                [0.352, 0.406, 0.493, 0.520, 0.578, 0.612], [0.411, 0.465, 0.545, 0.584, 0.658, 0.701],
                [0.481, 0.527, 0.601, 0.642, 0.704, 0.726], [0.699, 0.719, 0.757, 0.775, 0.794, 0.799],
                [0.848, 0.846, 0.862, 0.862, 0.869, 0.879], [0.948, 0.936, 0.932, 0.916, 0.937, 0.969],
                [1.002, 0.986, 0.974, 0.961, 0.963, 0.971], [1.029, 1.024, 1.008, 0.993, 0.990, 1.001],
                [1.029, 1.039, 1.027, 1.006, 1.016, 1.010], [0.999, 1.025, 1.024, 1.023, 1.009, 1.025],
                [1.000, 1.000, 1.000, 1.000, 1.000, 1.000]
            ]
        };

        const NOTCH_REMOVAL_MAP = { 10: null, 12: 3, 14: 4, 16: 4, 18: 5, 20: 5, 22: 5 };
        
        const TG129_DATA = {
            10: [{id:1,x:-2.30,y:-2.30,z:-2.01,ends:[{x:-3.89,y:-0.71,z:-2.01},{x:-0.71,y:-3.89,z:-2.01}]},{id:2,x:2.30,y:-2.30,z:-2.01,ends:[{x:0.71,y:-3.89,z:-2.01},{x:3.89,y:-0.71,z:-2.01}]},{id:3,x:2.30,y:2.30,z:-2.01,ends:[{x:3.89,y:0.71,z:-2.01},{x:0.71,y:3.89,z:-2.01}]},{id:4,x:-2.30,y:2.30,z:-2.01,ends:[{x:-0.71,y:3.89,z:-2.01},{x:-3.89,y:0.71,z:-2.01}]},{id:5,x:0,y:0,z:-2.40,ends:[{x:2.25,y:0,z:-2.40},{x:-2.25,y:0,z:-2.40}]}],
            12: [{id:1,x:-3.72,y:-2.70,z:-1.60,ends:[{x:-5.04,y:-0.88,z:-1.60},{x:-2.40,y:-4.52,z:-1.60}]},{id:2,x:1.42,y:-4.37,z:-1.60,ends:[{x:-0.72,y:-5.07,z:-1.60},{x:3.56,y:-3.68,z:-1.60}]},{id:3,x:4.60,y:0,z:-1.60,ends:[{x:4.60,y:-2.25,z:-1.60},{x:4.60,y:2.25,z:-1.60}]},{id:4,x:1.42,y:4.37,z:-1.60,ends:[{x:3.56,y:3.68,z:-1.60},{x:-0.72,y:5.07,z:-1.60}]},{id:5,x:-3.72,y:2.70,z:-1.60,ends:[{x:-2.40,y:4.52,z:-1.60},{x:-5.04,y:0.88,z:-1.60}]},{id:6,x:0,y:-2.70,z:-2.13,ends:[{x:-2.25,y:-2.70,z:-2.13},{x:2.25,y:-2.70,z:-2.13}]},{id:7,x:0,y:2.70,z:-2.13,ends:[{x:2.25,y:2.70,z:-2.13},{x:-2.25,y:2.70,z:-2.13}]},{id:8,x:0,y:0,z:-2.40,ends:[{x:2.25,y:0,z:-2.40},{x:-2.25,y:0,z:-2.40}]}],
            14: [{id:1,x:-5.90,y:0,z:-1.06,ends:[{x:-5.90,y:2.25,z:-1.06},{x:-5.90,y:-2.25,z:-1.06}]},{id:2,x:-2.95,y:-5.11,z:-1.06,ends:[{x:-4.90,y:-3.98,z:-1.06},{x:-1.00,y:-6.23,z:-1.06}]},{id:3,x:2.95,y:-5.11,z:-1.06,ends:[{x:1.00,y:-6.23,z:-1.06},{x:4.90,y:-3.98,z:-1.06}]},{id:4,x:5.90,y:0,z:-1.06,ends:[{x:5.90,y:-2.25,z:-1.06},{x:5.90,y:2.25,z:-1.06}]},{id:5,x:2.95,y:5.11,z:-1.06,ends:[{x:4.90,y:3.98,z:-1.06},{x:1.00,y:6.23,z:-1.06}]},{id:6,x:-2.95,y:5.11,z:-1.06,ends:[{x:-1.00,y:6.23,z:-1.06},{x:-4.90,y:3.98,z:-1.06}]},{id:7,x:-4.10,y:0,z:-1.77,ends:[{x:-4.10,y:2.25,z:-1.77},{x:-4.10,y:-2.25,z:-1.77}]},{id:8,x:0,y:-4.10,z:-1.77,ends:[{x:-2.25,y:-4.10,z:-1.77},{x:2.25,y:-4.10,z:-1.77}]},{id:9,x:4.10,y:0,z:-1.77,ends:[{x:4.10,y:-2.25,z:-1.77},{x:4.10,y:2.25,z:-1.77}]},{id:10,x:0,y:4.10,z:-1.77,ends:[{x:2.25,y:4.10,z:-1.77},{x:-2.25,y:4.10,z:-1.77}]},{id:11,x:0,y:-2.10,z:-2.24,ends:[{x:-2.25,y:-2.10,z:-2.24},{x:2.25,y:-2.10,z:-2.24}]},{id:12,x:0,y:2.10,z:-2.24,ends:[{x:2.25,y:2.10,z:-2.24},{x:-2.25,y:2.10,z:-2.24}]},{id:13,x:0,y:0,z:-2.40,ends:[{x:2.25,y:0,z:-2.40},{x:-2.25,y:0,z:-2.40}]}],
            16: [{id:1,x:-5.68,y:-2.73,z:-0.87,ends:[{x:-6.65,y:-0.71,z:-0.87},{x:-4.70,y:-4.76,z:-0.87}]},{id:2,x:-1.40,y:-6.14,z:-0.87,ends:[{x:-3.60,y:-5.64,z:-0.87},{x:0.79,y:-6.64,z:-0.87}]},{id:3,x:3.93,y:-4.93,z:-0.87,ends:[{x:2.17,y:-6.33,z:-0.87},{x:5.69,y:-3.52,z:-0.87}]},{id:4,x:6.30,y:0,z:-0.87,ends:[{x:6.30,y:-2.25,z:-0.87},{x:6.30,y:2.25,z:-0.87}]},{id:5,x:3.93,y:4.93,z:-0.87,ends:[{x:5.69,y:3.52,z:-0.87},{x:2.17,y:6.33,z:-0.87}]},{id:6,x:-1.40,y:6.14,z:-0.87,ends:[{x:0.79,y:6.64,z:-0.87},{x:-3.60,y:5.64,z:-0.87}]},{id:7,x:-5.68,y:2.73,z:-0.87,ends:[{x:-4.70,y:4.76,z:-0.87},{x:-6.65,y:0.71,z:-0.87}]},{id:8,x:-4.50,y:0,z:-1.64,ends:[{x:-4.50,y:2.25,z:-1.64},{x:-4.50,y:-2.25,z:-1.64}]},{id:9,x:0,y:-4.50,z:-1.64,ends:[{x:-2.25,y:-4.50,z:-1.64},{x:2.25,y:-4.50,z:-1.64}]},{id:10,x:4.50,y:0,z:-1.64,ends:[{x:4.50,y:-2.25,z:-1.64},{x:4.50,y:2.25,z:-1.64}]},{id:11,x:0,y:4.50,z:-1.64,ends:[{x:2.25,y:4.50,z:-1.64},{x:-2.25,y:4.50,z:-1.64}]},{id:12,x:0,y:-1.80,z:-2.28,ends:[{x:-2.25,y:-1.80,z:-2.28},{x:2.25,y:-1.80,z:-2.28}]},{id:13,x:0,y:1.80,z:-2.28,ends:[{x:2.25,y:1.80,z:-2.28},{x:-2.25,y:1.80,z:-2.28}]}],
            18: [{id:1,x:-7.70,y:0,z:-0.03,ends:[{x:-7.70,y:2.25,z:-0.03},{x:-7.70,y:-2.25,z:-0.03}]},{id:2,x:-5.44,y:-5.44,z:-0.03,ends:[{x:-7.04,y:-3.85,z:-0.03},{x:-3.85,y:-7.04,z:-0.03}]},{id:3,x:0,y:-7.70,z:-0.03,ends:[{x:-2.25,y:-7.70,z:-0.03},{x:2.25,y:-7.70,z:-0.03}]},{id:4,x:5.44,y:-5.44,z:-0.03,ends:[{x:3.85,y:-7.04,z:-0.03},{x:7.04,y:-3.85,z:-0.03}]},{id:5,x:7.70,y:0,z:-0.03,ends:[{x:7.70,y:-2.25,z:-0.03},{x:7.70,y:2.25,z:-0.03}]},{id:6,x:5.44,y:5.44,z:-0.03,ends:[{x:7.04,y:3.85,z:-0.03},{x:3.85,y:7.04,z:-0.03}]},{id:7,x:0,y:7.70,z:-0.03,ends:[{x:2.25,y:7.70,z:-0.03},{x:-2.25,y:7.70,z:-0.03}]},{id:8,x:-5.44,y:5.44,z:-0.03,ends:[{x:-3.85,y:7.04,z:-0.03},{x:-7.04,y:3.85,z:-0.03}]},{id:9,x:-6.20,y:0,z:-0.92,ends:[{x:-6.20,y:2.25,z:-0.92},{x:-6.20,y:-2.25,z:-0.92}]},{id:10,x:-3.10,y:-5.37,z:-0.92,ends:[{x:-5.05,y:-4.24,z:-0.92},{x:-1.15,y:-6.49,z:-0.92}]},{id:11,x:3.10,y:-5.37,z:-0.92,ends:[{x:1.15,y:-6.49,z:-0.92},{x:5.05,y:-4.24,z:-0.92}]},{id:12,x:6.20,y:0,z:-0.92,ends:[{x:6.20,y:-2.25,z:-0.92},{x:6.20,y:2.25,z:-0.92}]},{id:13,x:3.10,y:5.37,z:-0.92,ends:[{x:5.05,y:4.24,z:-0.92},{x:1.15,y:6.49,z:-0.92}]},{id:14,x:-3.10,y:5.37,z:-0.92,ends:[{x:-1.15,y:6.49,z:-0.92},{x:-5.05,y:4.24,z:-0.92}]},{id:15,x:-3.18,y:-3.18,z:-1.64,ends:[{x:-4.77,y:-1.59,z:-1.64},{x:-1.59,y:-4.77,z:-1.64}]},{id:16,x:3.18,y:-3.18,z:-1.64,ends:[{x:1.59,y:-4.77,z:-1.64},{x:4.77,y:-1.59,z:-1.64}]},{id:17,x:3.18,y:3.18,z:-1.64,ends:[{x:4.77,y:1.59,z:-1.64},{x:1.59,y:4.77,z:-1.64}]},{id:18,x:-3.18,y:3.18,z:-1.64,ends:[{x:-1.59,y:4.77,z:-1.64},{x:-4.77,y:1.59,z:-1.64}]},{id:19,x:0,y:-2.00,z:-2.25,ends:[{x:-2.25,y:-2.00,z:-2.25},{x:2.25,y:-2.00,z:-2.25}]},{id:20,x:0,y:2.00,z:-2.25,ends:[{x:2.25,y:2.00,z:-2.25},{x:-2.25,y:2.00,z:-2.25}]},{id:21,x:0,y:0,z:-2.40,ends:[{x:2.25,y:0,z:-2.40},{x:-2.25,y:0,z:-2.40}]}],
            20: [{id:1,x:-8.08,y:-2.94,z:0.64,ends:[{x:-8.85,y:-0.83,z:0.64},{x:-7.31,y:-5.06,z:0.64}]},{id:2,x:-4.30,y:-7.45,z:0.64,ends:[{x:-6.25,y:-6.32,z:0.64},{x:-2.35,y:-8.57,z:0.64}]},{id:3,x:1.49,y:-8.47,z:0.64,ends:[{x:-0.72,y:-8.86,z:0.64},{x:3.71,y:-8.08,z:0.64}]},{id:4,x:6.59,y:-5.53,z:0.64,ends:[{x:5.14,y:-7.25,z:0.64},{x:8.03,y:-3.80,z:0.64}]},{id:5,x:8.60,y:0,z:0.64,ends:[{x:8.60,y:-2.25,z:0.64},{x:8.60,y:2.25,z:0.64}]},{id:6,x:6.59,y:5.53,z:0.64,ends:[{x:8.03,y:3.80,z:0.64},{x:5.14,y:7.25,z:0.64}]},{id:7,x:1.49,y:8.47,z:0.64,ends:[{x:3.71,y:8.08,z:0.64},{x:-0.72,y:8.86,z:0.64}]},{id:8,x:-4.30,y:7.45,z:0.64,ends:[{x:-2.35,y:8.57,z:0.64},{x:-6.25,y:6.32,z:0.64}]},{id:9,x:-8.08,y:2.94,z:0.64,ends:[{x:-7.31,y:5.06,z:0.64},{x:-8.85,y:0.83,z:0.64}]},{id:10,x:-6.53,y:-1.49,z:-0.65,ends:[{x:-7.03,y:0.70,z:-0.65},{x:-6.03,y:-3.68,z:-0.65}]},{id:11,x:-2.91,y:-6.04,z:-0.65,ends:[{x:-4.93,y:-5.06,z:-0.65},{x:-0.88,y:-7.01,z:-0.65}]},{id:12,x:2.91,y:-6.04,z:-0.65,ends:[{x:0.88,y:-7.01,z:-0.65},{x:4.93,y:-5.06,z:-0.65}]},{id:13,x:6.53,y:-1.49,z:-0.65,ends:[{x:6.03,y:-3.68,z:-0.65},{x:7.03,y:0.70,z:-0.65}]},{id:14,x:5.24,y:4.18,z:-0.65,ends:[{x:6.64,y:2.42,z:-0.65},{x:3.84,y:5.94,z:-0.65}]},{id:15,x:0,y:6.70,z:-0.65,ends:[{x:2.25,y:6.70,z:-0.65},{x:-2.25,y:6.70,z:-0.65}]},{id:16,x:-5.24,y:4.18,z:-0.65,ends:[{x:-3.84,y:5.94,z:-0.65},{x:-6.64,y:2.42,z:-0.65}]},{id:17,x:-3.80,y:-2.76,z:-1.57,ends:[{x:-5.12,y:-0.94,z:-1.57},{x:-2.48,y:-4.58,z:-1.57}]},{id:18,x:1.45,y:-4.47,z:-1.57,ends:[{x:-0.69,y:-5.17,z:-1.57},{x:3.59,y:-3.77,z:-1.57}]},{id:19,x:4.70,y:0,z:-1.57,ends:[{x:4.70,y:-2.25,z:-1.57},{x:4.70,y:2.25,z:-1.57}]},{id:20,x:1.45,y:4.47,z:-1.57,ends:[{x:3.59,y:3.77,z:-1.57},{x:-0.69,y:5.17,z:-1.57}]},{id:21,x:-3.80,y:2.76,z:-1.57,ends:[{x:-2.48,y:4.58,z:-1.57},{x:-5.12,y:0.94,z:-1.57}]},{id:22,x:0,y:-2.25,z:-2.21,ends:[{x:-2.25,y:-2.25,z:-2.21},{x:2.25,y:-2.25,z:-2.21}]},{id:23,x:0,y:2.25,z:-2.21,ends:[{x:2.25,y:2.25,z:-2.21},{x:-2.25,y:2.25,z:-2.21}]},{id:24,x:0,y:0,z:-2.40,ends:[{x:2.25,y:0,z:-2.40},{x:-2.25,y:0,z:-2.40}]}],
            22: [{id:1,x:-9.20,y:0,z:1.15,ends:[{x:-9.20,y:2.25,z:1.15},{x:-9.20,y:-2.25,z:1.15}]},{id:2,x:-6.51,y:-6.51,z:1.15,ends:[{x:-8.10,y:-4.91,z:1.15},{x:-4.91,y:-8.10,z:1.15}]},{id:3,x:0,y:-9.20,z:1.15,ends:[{x:-2.25,y:-9.20,z:1.15},{x:2.25,y:-9.20,z:1.15}]},{id:4,x:6.51,y:-6.51,z:1.15,ends:[{x:4.91,y:-8.10,z:1.15},{x:8.10,y:-4.91,z:1.15}]},{id:5,x:9.20,y:0,z:1.15,ends:[{x:9.20,y:-2.25,z:1.15},{x:9.20,y:2.25,z:1.15}]},{id:6,x:6.51,y:6.51,z:1.15,ends:[{x:8.10,y:4.91,z:1.15},{x:4.91,y:8.10,z:1.15}]},{id:7,x:0,y:9.20,z:1.15,ends:[{x:2.25,y:9.20,z:1.15},{x:-2.25,y:9.20,z:1.15}]},{id:8,x:-6.51,y:6.51,z:1.15,ends:[{x:-4.91,y:8.10,z:1.15},{x:-8.10,y:4.91,z:1.15}]},{id:9,x:-7.19,y:-1.27,z:-0.29,ends:[{x:-7.58,y:0.95,z:-0.29},{x:-6.80,y:-3.48,z:-0.29}]},{id:10,x:-2.50,y:-6.86,z:-0.29,ends:[{x:-4.61,y:-6.09,z:-0.29},{x:-0.38,y:-7.63,z:-0.29}]},{id:11,x:4.69,y:-5.59,z:-0.29,ends:[{x:2.97,y:-7.04,z:-0.29},{x:6.42,y:-4.15,z:-0.29}]},{id:12,x:7.19,y:1.27,z:-0.29,ends:[{x:7.58,y:-0.95,z:-0.29},{x:6.80,y:3.48,z:-0.29}]},{id:13,x:2.50,y:6.86,z:-0.29,ends:[{x:4.61,y:6.09,z:-0.29},{x:0.38,y:7.63,z:-0.29}]},{id:14,x:-4.69,y:5.59,z:-0.29,ends:[{x:-2.97,y:7.04,z:-0.29},{x:-6.42,y:4.15,z:-0.29}]},{id:15,x:-3.09,y:-3.68,z:-1.53,ends:[{x:-4.81,y:-2.23,z:-1.53},{x:-1.36,y:-5.12,z:-1.53}]},{id:16,x:3.68,y:-3.09,z:-1.53,ends:[{x:2.23,y:-4.81,z:-1.53},{x:5.12,y:-1.36,z:-1.53}]},{id:17,x:3.09,y:3.68,z:-1.53,ends:[{x:4.81,y:2.23,z:-1.53},{x:1.36,y:5.12,z:-1.53}]},{id:18,x:-3.68,y:3.09,z:-1.53,ends:[{x:-2.23,y:4.81,z:-1.53},{x:-5.12,y:1.36,z:-1.53}]},{id:19,x:0.20,y:-2.24,z:-2.21,ends:[{x:-2.05,y:-2.44,z:-2.21},{x:2.44,y:-2.05,z:-2.21}]},{id:20,x:-0.20,y:2.24,z:-2.21,ends:[{x:2.05,y:2.44,z:-2.21},{x:-2.44,y:2.05,z:-2.21}]},{id:21,x:0,y:0,z:-2.40,ends:[{x:2.24,y:0.20,z:-2.40},{x:-2.24,y:-0.20,z:-2.40}]}]
        };

        // --- APP STATE ---
        const state = {
            size: 16, isNotched: false, calcMode: 'line', inputMode: 'duration',
            duration: 101.0, tumorHeight: 5.0, seedActivity: 0.00, showTable: false,
            // New state for back-calc
            calcDirection: 'forward', // 'forward' | 'backward'
            targetDose: 85.0,
            tpsValues: { ext_sclera: 0, sclera: 0, coms_5mm: 0, eye_origin: 0, opp_retina: 0, apex: 0 }
        };

        // --- GLOBAL DOM REFS (Initialized in init) ---
        let el = {};

        // --- PHYSICS CORE (TG-43 Standard) ---
        function calculate_g(r) {
            const data = state.calcMode === 'point' ? G_TABLE.point : G_TABLE.line;
            if (r <= G_TABLE.r[0]) return data[0];
            if (r >= G_TABLE.r[G_TABLE.r.length - 1]) return data[data.length - 1];
            let i = 0; while (i < G_TABLE.r.length - 1 && r > G_TABLE.r[i+1]) i++;
            return data[i] + (r - G_TABLE.r[i]) * (data[i+1] - data[i]) / (G_TABLE.r[i+1] - G_TABLE.r[i]);
        }

        function calculate_G_line(r, pt, seed) {
            const L = ISOTOPE_CONSTANTS.L;
            const u = { 
                x: (seed.ends[1].x - seed.ends[0].x) / 10, 
                y: (seed.ends[1].y - seed.ends[0].y) / 10, 
                z: (seed.ends[1].z - seed.ends[0].z) / 10 
            };
            const u_mag = Math.sqrt(u.x**2 + u.y**2 + u.z**2);
            const rv = { x: pt.x - seed.x/10, y: pt.y - seed.y/10, z: pt.z - seed.z/10 };
            const dot = rv.x*u.x + rv.y*u.y + rv.z*u.z;
            const theta = Math.acos(Math.max(-1, Math.min(1, dot/(r*u_mag))));
            const st = Math.sin(theta);
            if (Math.abs(st) < 0.0001) return 1 / (r**2 - (L/2)**2);
            return (Math.atan((r*Math.cos(theta)+L/2)/(r*st)) - Math.atan((r*Math.cos(theta)-L/2)/(r*st))) / (L*r*st);
        }

        function get_Theta_Deg(r, pt, seed) {
            const u = { 
                x: (seed.ends[1].x - seed.ends[0].x) / 10, 
                y: (seed.ends[1].y - seed.ends[0].y) / 10, 
                z: (seed.ends[1].z - seed.ends[0].z) / 10 
            };
            const rv = { x: pt.x - seed.x/10, y: pt.y - seed.y/10, z: pt.z - seed.z/10 };
            const dot = rv.x*u.x + rv.y*u.y + rv.z*u.z;
            return Math.acos(Math.max(-1, Math.min(1, dot/(r*Math.sqrt(u.x**2+u.y**2+u.z**2))))) * 180 / Math.PI;
        }

        function get_F(r, theta_deg) {
            let t = theta_deg > 90 ? 180 - theta_deg : Math.max(0, theta_deg);
            const reff = Math.max(0.5, Math.min(r, 7.0));
            let i = 0; while (i < F_TABLE.r.length - 2 && reff > F_TABLE.r[i+1]) i++;
            let j = 0; while (j < F_TABLE.theta.length - 2 && t > F_TABLE.theta[j+1]) j++;
            const r1 = F_TABLE.r[i], r2 = F_TABLE.r[i+1], t1 = F_TABLE.theta[j], t2 = F_TABLE.theta[j+1];
            const Q11 = F_TABLE.data[j][i], Q12 = F_TABLE.data[j][i+1], Q21 = F_TABLE.data[j+1][i], Q22 = F_TABLE.data[j+1][i+1];
            const f_r_t1 = Q11 + (reff - r1) * (Q12 - Q11) / (r2 - r1);
            const f_r_t2 = Q21 + (reff - r1) * (Q22 - Q21) / (r2 - r1);
            return f_r_t1 + (t - t1) * (f_r_t2 - f_r_t1) / (t2 - t1);
        }

        const G_REF_L = (function(){ const r=1, t=Math.PI/2, L=0.3; return (Math.atan(L/(2*r)) - Math.atan(-L/(2*r))) / (L*r); })();

        // --- CALCULATIONS ---
        function calculateAll() {
            if (!el.doseApex || state.duration < 0) return;
            const lambda = Math.LN2 / (ISOTOPE_CONSTANTS.HalfLife * 24.0);
            const df = (state.duration > 0) ? (1 - Math.exp(-lambda * state.duration)) / lambda : 0;
            const gref = state.calcMode === 'point' ? 1 : G_REF_L;
            const { active } = getProcessedSeeds();
            
            // --- BACKWARD CALCULATION LOGIC ---
            if (state.calcDirection === 'backward') {
                if (df <= 0) {
                    // Cannot calc activity if duration is 0
                    el.calculatedActivityDisplay.textContent = "Inf";
                    return;
                }
                
                // 1. Calculate Geometry Factor Sum at Apex
                const apex_pt = { x: 0, y: 0, z: state.tumorHeight / 10 };
                let apex_geom_sum = 0;
                
                active.forEach(s => {
                    const r = Math.sqrt((apex_pt.x - s.x/10)**2 + (apex_pt.y - s.y/10)**2 + (apex_pt.z - s.z/10)**2);
                    const g = calculate_g(r);
                    let G, F;
                    if (state.calcMode === 'point') { G = 1/r**2; F = 1; }
                    else { G = calculate_G_line(r, apex_pt, s); F = get_F(r, get_Theta_Deg(r, apex_pt, s)); }
                    apex_geom_sum += (ISOTOPE_CONSTANTS.Lambda * (G / gref) * g * F);
                });
                
                // 2. Solve for Activity: Dose = (Activity * GeomSum * df) / 100
                //    Activity = (Dose * 100) / (GeomSum * df)
                if (apex_geom_sum > 0) {
                    const requiredAct = (state.targetDose * 100.0) / (apex_geom_sum * df);
                    state.seedActivity = requiredAct;
                    el.calculatedActivityDisplay.textContent = requiredAct.toFixed(3) + " U";
                    // Update the hidden activity input so if they toggle back, it's correct
                    el.seedActivity.value = requiredAct.toFixed(3);
                } else {
                    el.calculatedActivityDisplay.textContent = "Err";
                }
            } else {
                // Forward mode: Update seedActivity from input, ensure no negative
                state.seedActivity = Math.max(0, parseFloat(el.seedActivity.value) || 0);
            }

            // --- FORWARD PASS (For all points) ---
            const pts_coords = { 
                ext_sclera: { x: 0, y: 0, z: -0.1 }, 
                sclera: { x: 0, y: 0, z: 0 }, 
                coms_5mm: { x: 0, y: 0, z: 0.5 }, 
                eye_origin: { x: 0, y: 0, z: 1.1 }, 
                opp_retina: { x: 0, y: 0, z: 2.2 }, 
                apex: { x: 0, y: 0, z: state.tumorHeight / 10 } 
            };
            
            const res = {};
            for (const [k, p] of Object.entries(pts_coords)) {
                let dose = 0;
                active.forEach(s => {
                    const r = Math.sqrt((p.x - s.x/10)**2 + (p.y - s.y/10)**2 + (p.z - s.z/10)**2);
                    const g = calculate_g(r);
                    let G, F;
                    if (state.calcMode === 'point') { G = 1/r**2; F = 1; }
                    else { G = calculate_G_line(r, p, s); F = get_F(r, get_Theta_Deg(r, p, s)); }
                    dose += (state.seedActivity * ISOTOPE_CONSTANTS.Lambda * (G / gref) * g * F * df) / 100;
                });
                res[k] = dose;
            }
            
            el.doseApex.textContent = res.apex.toFixed(2);
            el.doseApexLabel.textContent = `(${state.tumorHeight}mm)`;
            updateTableDisplay(res);
            renderPhysicsTable(active, pts_coords.apex, gref, df);
        }

        function updateTableDisplay(results) {
            const pts = [
                { id: 'ext_sclera', name: 'External Sclera (-1mm)' },
                { id: 'sclera', name: 'Inner Sclera (0mm)' },
                { id: 'coms_5mm', name: 'COMS Reference (5mm)' },
                { id: 'eye_origin', name: 'Eye Origin (11mm)' },
                { id: 'opp_retina', name: 'Opposite Retina (22mm)' },
                { id: 'apex', name: 'Rx Depth (Apex)' }
            ];
            el.comparisonRows.innerHTML = pts.map(pt => `
                <tr class="hover:bg-green-100/30 transition-colors">
                    <td class="py-1.5 px-1 text-[11px] font-semibold text-gray-700 leading-tight">${pt.name}</td>
                    <td class="py-1.5 px-1 text-[14px] font-mono font-semibold text-right text-gray-800" id="comp-calc-${pt.id}">${results[pt.id].toFixed(2)}</td>
                    <td class="py-1.5 px-1 text-center">
                        <input type="text" value="${state.tpsValues[pt.id] || ''}" class="w-16 text-right p-0.5 text-[13px] font-mono font-bold border border-green-200 rounded bg-white focus:ring-1 focus:ring-green-400 outline-none tps-input" data-id="${pt.id}" >
                    </td>
                    <td class="py-1.5 px-1 text-right text-[12px] font-black" id="comp-diff-${pt.id}">${calculateError(results[pt.id], state.tpsValues[pt.id])}</td>
                </tr>
            `).join('');
            document.querySelectorAll('.tps-input').forEach(i => i.addEventListener('input', e => { 
                const id = e.target.dataset.id;
                const val = e.target.value.replace(/[^0-9.]/g, ''); 
                state.tpsValues[id] = parseFloat(val) || 0; 
                const calcVal = parseFloat(document.getElementById(`comp-calc-${id}`).textContent);
                document.getElementById(`comp-diff-${id}`).innerHTML = calculateError(calcVal, state.tpsValues[id]);
            }));
        }

        function calculateError(calc, tps) {
            if (tps > 0 && calc >= 0) {
                const diff = ((calc - tps) / tps) * 100;
                return `<span class="${Math.abs(diff) <= 5 ? 'text-green-600' : 'text-red-600'}">${(diff > 0 ? "+" : "") + diff.toFixed(1)}%</span>`;
            }
            return '<span class="text-gray-400">-</span>';
        }

        function renderPhysicsTable(seeds, p, gref, df) {
            let html = '', total = 0;
            seeds.forEach(s => {
                const r = Math.sqrt((p.x - s.x/10)**2 + (p.y - s.y/10)**2 + (p.z - s.z/10)**2);
                const g = calculate_g(r); let G, F, tv;
                if (state.calcMode === 'point') { G = 1/r**2; F = 1; tv = 90; }
                else { G = calculate_G_line(r, p, s); tv = get_Theta_Deg(r, p, s); F = get_F(r, tv); }
                const dose = (state.seedActivity * ISOTOPE_CONSTANTS.Lambda * (G / gref) * g * F * df) / 100;
                total += dose;
                html += `<tr class="hover:bg-gray-50 border-b border-gray-100"><td class="py-2 px-3">${s.displayId}</td><td class="py-2 px-3 text-gray-400 font-mono">${s.x.toFixed(2)}</td><td class="py-2 px-3 text-gray-400 font-mono">${s.y.toFixed(2)}</td><td class="py-2 px-3 text-gray-400 font-mono">${s.z.toFixed(2)}</td><td class="py-2 px-3 font-medium font-mono">${(r * 10).toFixed(3)}</td><td class="py-2 px-3 text-gray-500 font-mono">${tv.toFixed(1)}</td><td class="py-2 px-3 font-bold text-green-600 font-mono">${g.toFixed(4)}</td><td class="py-2 px-3 font-mono">${G.toFixed(4)}</td><td class="py-2 px-3 font-bold text-blue-600 font-mono">${F.toFixed(4)}</td><td class="py-2 px-3 font-bold text-gray-800 font-mono">${dose.toFixed(4)}</td></tr>`;
            });
            el.tableBody.innerHTML = html; el.tableTotal.textContent = total.toFixed(4) + " Gy";
        }

        // --- DRAWING FUNCTIONS ---
        function drawPlaque() {
            if (!el.canvas) return;
            const ctx = el.canvas.getContext('2d'); const w = el.canvas.width, h = el.canvas.height;
            ctx.clearRect(0, 0, w, h);
            const { active, removed } = getProcessedSeeds();
            const cx = w / 2; 
            const cy = 210; // Centered to handle fixed proportion scale nicely
            const scale = 18; 
            
            ctx.beginPath(); ctx.arc(cx, cy, (state.size/2)*scale, 0, 2*Math.PI); ctx.fillStyle = '#FFD700'; ctx.fill(); ctx.strokeStyle = '#B8860B'; ctx.lineWidth = 2; ctx.stroke();
            if (removed) drawSeed(ctx, removed, cx, cy, scale, true); 
            active.forEach(s => drawSeed(ctx, s, cx, cy, scale, false));
            
            if (el.plaqueDescLabel) {
                el.plaqueDescLabel.textContent = `${state.size}mm COMS (${state.isNotched ? 'Notched' : 'Round'})`;
            }
            if (el.plaqueSeedCount) {
                el.plaqueSeedCount.textContent = `Seeds: ${active.length}`;
            }
        }

        function drawSeed(ctx, s, cx, cy, scale, isRem) {
            const px = cx + s.x * scale, py = cy - s.y * scale;
            ctx.save(); ctx.translate(px, py); 
            ctx.rotate(Math.atan2(-(s.ends[1].y - s.ends[0].y), s.ends[1].x - s.ends[0].x));
            ctx.beginPath(); ctx.moveTo(-1.8 * scale, 0); ctx.lineTo(1.8 * scale, 0); ctx.lineCap = 'round'; 
            ctx.lineWidth = Math.max(9, scale * 0.6); 
            ctx.strokeStyle = isRem ? '#ef4444' : '#9ca3af'; ctx.stroke(); ctx.restore();
            if (!isRem) {
                const radius = Math.max(11, scale * 0.8); 
                ctx.beginPath(); ctx.arc(px, py, radius, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill(); ctx.strokeStyle = 'blue'; ctx.lineWidth = 1; ctx.stroke();
                const fontSize = Math.max(13, scale * 1);
                ctx.fillStyle = 'blue'; ctx.font = `bold ${fontSize}px sans-serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(s.displayId, px, py);
            }
        }

        function getProcessedSeeds() {
            let seeds = [...TG129_DATA[state.size]]; let removed = null;
            if (state.isNotched && NOTCH_REMOVAL_MAP[state.size]) {
                const target = NOTCH_REMOVAL_MAP[state.size];
                removed = seeds.find(s => s.id === target);
                seeds = seeds.filter(s => s.id !== target).map((s, idx) => ({ ...s, displayId: idx + 1 }));
            } else { seeds = seeds.map(s => ({ ...s, displayId: s.id })); }
            return { active: seeds, removed };
        }

        function setInputMode(mode) {
            state.inputMode = mode;
            if (mode === 'duration') {
                el.modeContentDuration.classList.remove('hidden'); el.modeContentDates.classList.add('hidden');
                el.btnModeDuration.className = "flex-1 py-1.5 text-xs font-bold uppercase text-blue-900 bg-blue-50 border-b-2 border-blue-600 focus:outline-none";
                el.btnModeDates.className = "flex-1 py-1.5 text-xs font-bold uppercase text-blue-400 hover:text-blue-600 border-b-2 border-transparent focus:outline-none";
            } else {
                el.modeContentDuration.classList.add('hidden'); el.modeContentDates.classList.remove('hidden');
                el.btnModeDates.className = "flex-1 py-1.5 text-xs font-bold uppercase text-blue-900 bg-blue-50 border-b-2 border-blue-600 focus:outline-none";
                el.btnModeDuration.className = "flex-1 py-1.5 text-xs font-bold uppercase text-blue-400 hover:text-blue-600 border-b-2 border-transparent focus:outline-none";
                syncDatesFromDuration();
            }
        }

        function setCalcMode(dir) {
            state.calcDirection = dir;
            if (dir === 'forward') {
                el.inputGroupActivity.classList.remove('hidden');
                el.inputGroupDose.classList.add('hidden');
                el.btnCalcFwd.className = "px-2 py-0.5 text-[10px] font-bold rounded shadow bg-white text-blue-800 transition-all";
                el.btnCalcBwd.className = "px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-gray-600 transition-all";
            } else {
                el.inputGroupActivity.classList.add('hidden');
                el.inputGroupDose.classList.remove('hidden');
                el.btnCalcBwd.className = "px-2 py-0.5 text-[10px] font-bold rounded shadow bg-white text-blue-800 transition-all";
                el.btnCalcFwd.className = "px-2 py-0.5 text-[10px] font-bold rounded text-gray-400 hover:text-gray-600 transition-all";
            }
            calculateAll();
        }

        function handleManualDurationChange(e) {
            const val = parseFloat(e.target.value);
            if (!isNaN(val) && val >= 0) { state.duration = val; syncDatesFromDuration(); updateDecayFactor(); calculateAll(); }
        }

        function handleDateChange() {
            if (el.implantDate.value && el.removalDate.value) {
                const diffMs = new Date(el.removalDate.value) - new Date(el.implantDate.value);
                state.duration = Math.max(0, diffMs / (1000 * 60 * 60));
                el.manualDuration.value = state.duration.toFixed(1);
                updateDecayFactor(); calculateAll();
            }
        }

        function syncDatesFromDuration() {
            if (el.implantDate.value && state.duration >= 0) {
                const end = new Date(new Date(el.implantDate.value).getTime() + state.duration * 60 * 60 * 1000);
                const ry = end.getFullYear(), rm = String(end.getMonth() + 1).padStart(2, '0'), rd = String(end.getDate()).padStart(2, '0'), rh = String(end.getHours()).padStart(2, '0'), rmin = String(end.getMinutes()).padStart(2, '0');
                el.removalDate.value = `${ry}-${rm}-${rd}T${rh}:${rmin}`;
            }
        }

        function updateDecayFactor() {
            const lambda = Math.LN2 / (ISOTOPE_CONSTANTS.HalfLife * 24.0);
            const df = state.duration > 0 ? (1 - Math.exp(-lambda * state.duration)) / lambda : 0;
            el.decayFactorDisplay.textContent = df.toFixed(3) + ' h';
            el.dateModeDurationDisplay.textContent = state.duration.toFixed(1) + ' h';
        }

        function handlePlaqueSizeChange(e) {
            const val = parseInt(e.target.value);
            if (TG129_DATA[val]) {
                state.size = val;
                if (val === 10) { state.isNotched = false; document.querySelector('input[value="round"]').checked = true; el.radioNotched.disabled = true; el.labelNotched.classList.add('opacity-50'); }
                else { el.radioNotched.disabled = false; el.labelNotched.classList.remove('opacity-50'); }
                calculateAll(); drawPlaque();
            }
        }

        function init() {
            // Populate element references inside init to ensure DOM is ready
            el = {
                btnModeDuration: document.getElementById('btn-mode-duration'),
                btnModeDates: document.getElementById('btn-mode-dates'),
                modeContentDuration: document.getElementById('mode-content-duration'),
                modeContentDates: document.getElementById('mode-content-dates'),
                manualDuration: document.getElementById('manualDuration'),
                dateModeDurationDisplay: document.getElementById('dateModeDurationDisplay'),
                implantDate: document.getElementById('implantDate'),
                removalDate: document.getElementById('removalDate'),
                decayFactorDisplay: document.getElementById('decayFactorDisplay'),
                
                // Inputs & Calc Mode Refs
                btnCalcFwd: document.getElementById('mode-calc-fwd'),
                btnCalcBwd: document.getElementById('mode-calc-bwd'),
                inputGroupActivity: document.getElementById('input-group-activity'),
                inputGroupDose: document.getElementById('input-group-dose'),
                seedActivity: document.getElementById('seedActivity'),
                targetDoseInput: document.getElementById('targetDoseInput'),
                calculatedActivityDisplay: document.getElementById('calculatedActivityDisplay'),

                tumorHeight: document.getElementById('tumorHeight'),
                plaqueSize: document.getElementById('plaqueSize'),
                radioNotched: document.getElementById('radioNotched'),
                labelNotched: document.getElementById('labelNotched'),
                notchLegend: document.getElementById('notchLegend'),
                doseApex: document.getElementById('dose-apex'),
                doseApexLabel: document.getElementById('dose-apex-label'),
                toggleTableBtn: document.getElementById('toggleTableBtn'),
                tableContainer: document.getElementById('detailedTableContainer'),
                tableBody: document.getElementById('detailedTableBody'),
                tableTotal: document.getElementById('detailedTableTotal'),
                canvas: document.getElementById('plaqueCanvas'),
                comparisonRows: document.getElementById('comparison-rows'),
                plaqueDescLabel: document.getElementById('plaque-desc-label'),
                plaqueSeedCount: document.getElementById('plaque-seed-count')
            };

            const now = new Date(); const dayOfWeek = now.getDay(); 
            const diffToMonday = (dayOfWeek === 0 ? -6 : 1 - dayOfWeek);
            const targetMonday = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToMonday + 21);
            const y = targetMonday.getFullYear(), m = String(targetMonday.getMonth() + 1).padStart(2, '0'), d = String(targetMonday.getDate()).padStart(2, '0');
            el.implantDate.value = `${y}-${m}-${d}T08:30`;
            state.duration = 101.0; el.manualDuration.value = "101.0";
            state.seedActivity = 0.00; el.seedActivity.value = "0.00";
            el.btnModeDuration.addEventListener('click', () => setInputMode('duration'));
            el.btnModeDates.addEventListener('click', () => setInputMode('dates'));
            el.manualDuration.addEventListener('input', handleManualDurationChange);
            el.implantDate.addEventListener('input', handleDateChange);
            el.removalDate.addEventListener('input', handleDateChange);
            
            // Listeners for Calculation Mode
            el.btnCalcFwd.addEventListener('click', () => setCalcMode('forward'));
            el.btnCalcBwd.addEventListener('click', () => setCalcMode('backward'));
            
            // Input Listeners
            el.seedActivity.addEventListener('input', e => { state.seedActivity = parseFloat(e.target.value) || 0; calculateAll(); });
            el.targetDoseInput.addEventListener('input', e => { state.targetDose = parseFloat(e.target.value) || 0; calculateAll(); });

            el.tumorHeight.addEventListener('input', e => { state.tumorHeight = parseFloat(e.target.value) || 0; calculateAll(); });
            el.plaqueSize.addEventListener('change', handlePlaqueSizeChange);
            document.getElementsByName('shape').forEach(r => r.addEventListener('change', e => { state.isNotched = (e.target.value === 'notched'); calculateAll(); drawPlaque(); }));
            document.getElementsByName('calcMode').forEach(r => r.addEventListener('change', e => { state.calcMode = e.target.value; calculateAll(); }));
            el.toggleTableBtn.addEventListener('click', () => { 
                state.showTable = !state.showTable; el.tableContainer.classList.toggle('hidden'); 
                el.toggleTableBtn.textContent = state.showTable ? "Hide Detailed Physics Check" : "Show Detailed Physics Check"; 
            });
            syncDatesFromDuration(); updateDecayFactor(); calculateAll(); drawPlaque();
        }
        window.onload = init;
    </script>
</body>
</html>